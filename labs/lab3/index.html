<!DOCTYPE html>
<html lang="en">
    <head>
      <title> ECE 382 </title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <link rel='stylesheet' type='text/css' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
      <!-- <link rel='stylesheet' type='text/css' href='https://cdn.rawgit.com/MarsUniversity/ece382/master/source/pandoc.css'> -->
      <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>
      <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [["$","$"],["\\(","\\)"]]
          }
        });
      </script>

      <style type="text/css">
           code{white-space: pre-wrap;}
           span.smallcaps{font-variant: small-caps;}
           span.underline{text-decoration: underline;}
           div.column{display: inline-block; vertical-align: top; width: 50%;}
       </style>
       <style type="text/css">
     a.sourceLine { display: inline-block; line-height: 1.25; }
     a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
     a.sourceLine:empty { height: 1.2em; }
     .sourceCode { overflow: visible; }
     code.sourceCode { white-space: pre; position: relative; }
     div.sourceCode { margin: 1em 0; }
     pre.sourceCode { margin: 0; }
     @media screen {
     div.sourceCode { overflow: auto; }
     }
     @media print {
     code.sourceCode { white-space: pre-wrap; }
     a.sourceLine { text-indent: -1em; padding-left: 1em; }
     }
     pre.numberSource a.sourceLine
       { position: relative; left: -4em; }
     pre.numberSource a.sourceLine::before
       { content: attr(data-line-number);
         position: relative; left: -1em; text-align: right; vertical-align: baseline;
         border: none; pointer-events: all; display: inline-block;
         -webkit-touch-callout: none; -webkit-user-select: none;
         -khtml-user-select: none; -moz-user-select: none;
         -ms-user-select: none; user-select: none;
         padding: 0 4px; width: 4em;
         color: #aaaaaa;
       }
     pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
     div.sourceCode
       {  }
     @media screen {
     a.sourceLine::before { text-decoration: underline; }
     }
     code span.al { color: #ff0000; font-weight: bold; } /* Alert */
     code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
     code span.at { color: #7d9029; } /* Attribute */
     code span.bn { color: #40a070; } /* BaseN */
     code span.bu { } /* BuiltIn */
     code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
     code span.ch { color: #4070a0; } /* Char */
     code span.cn { color: #880000; } /* Constant */
     code span.co { color: #60a0b0; font-style: italic; } /* Comment */
     code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
     code span.do { color: #ba2121; font-style: italic; } /* Documentation */
     code span.dt { color: #902000; } /* DataType */
     code span.dv { color: #40a070; } /* DecVal */
     code span.er { color: #ff0000; font-weight: bold; } /* Error */
     code span.ex { } /* Extension */
     code span.fl { color: #40a070; } /* Float */
     code span.fu { color: #06287e; } /* Function */
     code span.im { } /* Import */
     code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
     code span.kw { color: #007020; font-weight: bold; } /* Keyword */
     code span.op { color: #666666; } /* Operator */
     code span.ot { color: #007020; } /* Other */
     code span.pp { color: #bc7a00; } /* Preprocessor */
     code span.sc { color: #4070a0; } /* SpecialChar */
     code span.ss { color: #bb6688; } /* SpecialString */
     code span.st { color: #4070a0; } /* String */
     code span.va { color: #19177c; } /* Variable */
     code span.vs { color: #4070a0; } /* VerbatimString */
     code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

     img {
      display: block;
      margin-left: auto;
      margin-right: auto;
     }


     html {
       font-size: 100%;
       overflow-y: scroll;
       -webkit-text-size-adjust: 100%;
       -ms-text-size-adjust: 100%;
     }

     body {
       color: #444;
       font-family: Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif;
       /*font-size: 14px;*/
       line-height: 1.7;
       padding: 1em;
       margin: auto;
       /*max-width: 42em;*/
       max-width: 90%;
       /* background: #fefefe; */
     }

     a {
       color: #0645ad;
       text-decoration: none;
     }

     a:visited {
       color: #0b0080;
     }

     a:hover {
       color: #06e;
     }

     a:active {
       color: #faa700;
     }

     a:focus {
       outline: thin dotted;
     }

     *::-moz-selection {
       background: rgba(255, 255, 0, 0.3);
       color: #000;
     }

     *::selection {
       background: rgba(255, 255, 0, 0.3);
       color: #000;
     }

     a::-moz-selection {
       background: rgba(255, 255, 0, 0.3);
       color: #0645ad;
     }

     a::selection {
       background: rgba(255, 255, 0, 0.3);
       color: #0645ad;
     }

     p {
       margin: 1em 0;
     }

     img {
       max-width: 100%;
     }

     h1, h2, h3, h4, h5, h6 {
       color: #111;
       line-height: 125%;
       margin-top: 1em;
       font-weight: normal;
     }

     h4, h5, h6 {
       font-weight: bold;
     }

     h1 {
       font-size: 2.5em;
     }

     h2 {
       font-size: 2em;
     }

     h3 {
       font-size: 1.5em;
     }

     h4 {
       font-size: 1.2em;
     }

     h5 {
       font-size: 1em;
     }

     h6 {
       font-size: 0.9em;
     }

     blockquote {
       color: #666666;
       margin: 0;
       padding-left: 3em;
       border-left: 0.5em #EEE solid;
     }

     hr {
       display: block;
       height: 2px;
       border: 0;
       border-top: 1px solid #aaa;
       border-bottom: 1px solid #eee;
       margin: 1em 0;
       padding: 0;
     }

     pre, code, kbd, samp {
       color: #000;
       font-family: monospace, monospace;
       /*_font-family: 'courier new', monospace;*/
       font-size: 0.98em;
     }

     pre {
       white-space: pre;
       white-space: pre-wrap;
       word-wrap: break-word;
     }

     b, strong {
       font-weight: bold;
     }

     dfn {
       font-style: italic;
     }

     ins {
       background: #ff9;
       color: #000;
       text-decoration: none;
     }

     mark {
       background: #ff0;
       color: #000;
       font-style: italic;
       font-weight: bold;
     }

     sub, sup {
       font-size: 75%;
       line-height: 0;
       position: relative;
       vertical-align: baseline;
     }

     sup {
       top: -0.5em;
     }

     sub {
       bottom: -0.25em;
     }

     ul, ol {
       margin: 1em 0;
       padding: 0 0 0 2em;
     }

     li p:last-child {
       margin-bottom: 0;
     }

     ul ul, ol ol {
       margin: .3em 0;
     }

     dl {
       margin-bottom: 1em;
     }

     dt {
       font-weight: bold;
       margin-bottom: .8em;
     }

     dd {
       margin: 0 0 .8em 2em;
     }

     dd:last-child {
       margin-bottom: 0;
     }

     img {
       border: 0;
       -ms-interpolation-mode: bicubic;
       vertical-align: middle;
     }

     figure {
       display: block;
       text-align: center;
       margin: 1em 0;
     }

     figure img {
       border: none;
       margin: 0 auto;
     }

     figcaption {
       font-size: 0.8em;
       font-style: italic;
       margin: 0 0 .8em;
     }

     table {
       margin-left:auto;
       margin-right:auto;
       margin-bottom: 2em;
       border-bottom: 1px solid #ddd;
       border-right: 1px solid #ddd;
       border-spacing: 0;
       border-collapse: collapse;
     }

     table th {
       padding: .2em 1em;
       background-color: #0099ff;
       border-top: 1px solid #ddd;
       border-left: 1px solid #ddd;
       color: white;
     }

     /*.even {background-color: #f2f2f2}*/
     tr:nth-child(even) {background-color: #f2f2f2}

     table td {
       padding: .2em 1em;
       border-top: 1px solid #ddd;
       border-left: 1px solid #ddd;
       vertical-align: top;
     }
       </style>


    </head>
    <body>
        <div class = "container"> <!-- center navbar on page -->
            <!-- <nav class = "navbar navbar-default navbar-inverse bg-inverse"> -->
            <nav class="navbar navbar-inverse bg-inverse">
                <div class = "container-fluid">
                    <div class="navbar-header">
                    <a class = "navbar-brand" href="./../../index.html">ECE382</a>
                  </div>
                    <ul class = "nav navbar-nav">
                        <li><a href="./../../index.html">Home</a></li>
                        <li><a href="./../../labs/index.html">Labs</a></li>
                        <li><a href="./../../references/index.html">References</a></li>
                    </ul>
                </div>
            </nav>
            <h1 id="lab-3---interrupts---remote-control-decoding">Lab 3 - Interrupts - &#8220;Remote Control Decoding&#8221;</h1>
<p>You have already seen serial communication in Lab 2, but you will see it again here. This time, instead of sending the signal across a wire, we will send it through the air as modulated light.</p>
<p>Your task for this lab is to reverse engineer (hack) an IR remote control so you can get it to light up some LEDs for you. Unfortunately, IR remotes don&#8217;t really follow much of a standard, but they tend to operate similar to each other. We will exploit that to learn how they work.</p>
<hr />
<p><strong>WARNING:</strong> This lab has been around for a while, but I have changed it this semester. If I see your code <em>looks</em> like work from previous years, I will <em>assume</em> you are cheating and you will loose <strong>a lot of points</strong>. Depending on how bad it looks, it could result in an honor case.</p>
<hr />
<h2 id="objectives">Objectives</h2>
<ul>
<li>Use the Time A subsystem</li>
<li>Reverse engineer a protocol</li>
<li>Use the capture compare peripheral</li>
<li>Use interrupts</li>
<li>Combine assembly and C code</li>
<li>Communicate with external hardware</li>
</ul>
<h2 id="handy-references">Handy References</h2>
<ul>
<li>IR Receiver TSOP382 <a href="../../references/tsop382.pdf">datasheet</a></li>
</ul>
<h2 id="given-code">Given code</h2>
<ul>
<li><a href="./test3.c">test3.c</a>: Use this file to characterize the buttons of your remote</li>
<li><a href="./start3.c">start3.c</a>: Initial template file for lab</li>
<li><a href="./delay_code.asm">delay_code.asm</a>: simple code that gives you a couple simple delay times written in assembly</li>
</ul>
<h1 id="directions">Directions</h1>
<p>You will need to use the timer interrupt and the general purpose pin interrupt to decode a remote control. Be sure to pick one remote for the whole lab, as remote codes vary between manufacturer.</p>
<h2 id="daily-milestones">Daily Milestones</h2>
<p>This lab will be completed in 3 steps:</p>
<ul>
<li><strong>Lab day 1:</strong> Characterize the IR buttons: learn the timing and bit patterns for your remote control (<em>hint:</em> use the logic analyzer)</li>
<li><strong>Lab day 2:</strong> Use interrupts to capture IR packets: demonstrate your code can receive and decode button presses from the remote control</li>
<li><strong>Lab day 3:</strong> Demonstrate turning LEDs on/off</li>
</ul>
<p><strong>If you finish a day early, move on to the next day&#8217;s work</strong></p>
<p><strong>Please do the prelabs, they will help you meet the above deadlines</strong></p>
<h1 id="day-1">Day 1</h1>
<h2 id="prelab-1">Prelab 1</h2>
<p>I will not check these, but you need to do them to stay on track.</p>
<ul>
<li>Fill in the missing code for <a href="test3.c" class="uri">test3.c</a></li>
<li>Print the tables you need for <a href="tables.html">Day 1 and 2</a></li>
</ul>
<h2 id="connecting-the-ir-sensor">Connecting the IR sensor</h2>
<p><strong>Do Not Power Your Board When You Are Wiring It Up!</strong></p>
<p>Insert the IR receiver module into the protoboard. Look at the datasheet and make sure you are wiring up the receiver module correctly. When you are looking at the sensor ball on your IR receiver module, the pin on the left is your signal pin; the pin in the middle is your ground pin; and the pin on the right is your Vcc.</p>
<figure>
<img src="ir_sensor.jpg" alt="IR Sensor Datasheet excerpt" style="width:50.0%" /><figcaption>IR Sensor Datasheet excerpt</figcaption>
</figure>
<p>Hook up your Launchpad to the IR module as shown in either picture:</p>
<p><img src="launchpadSetup.jpg" style="width:75.0%" /></p>
<p>On your MSP430, connect:</p>
<ul>
<li>the sensor signal pin to XIN/P2.6</li>
<li>the sensor ground pin to the GND pin</li>
<li>the sensor Vcc pin to Vcc on the MSP430</li>
</ul>
<h2 id="connecting-to-the-logic-analyzer">Connecting to the Logic Analyzer</h2>
<p>When hooking up to the logic analyzer, remember to connect the MSP430 ground to the logic analyzer ground. Also, hook the signal from the IR sensor to one of the POD1 inputs bits.</p>
<p><img src="pics/settings.jpg" /></p>
<p>Following the picture above:</p>
<ul>
<li>Sampling period: 200 nsec</li>
<li>Acquisition Depth (how many samples): 4M</li>
<li>Trigger Position: 90% post store</li>
</ul>
<h2 id="measure-timer-counts">Measure Timer Counts</h2>
<ol type="1">
<li>Build a project around <em>your modified</em> <code>test3.c</code> and then download it onto your LaunchPad. Make sure to open the variables tab (View -&gt; Variables).
<ul>
<li>I also like to clear memory from the Memory Browser tab (View -&gt; Memory Browser), Fill Memory from 0x200 to 0x400 with 0&#8217;s.</li>
</ul></li>
<li>Set the Logic analyzer to &#8220;Run Single&#8221;</li>
<li>Run the program and then press a button on a remote.</li>
<li>Pause the program and look at the variables. You should see something like the following. The values are the captured wave form from the remote.</li>
</ol>
<figure>
<img src="arrayScreenShot.gif" alt="array screen shot" /><figcaption>array screen shot</figcaption>
</figure>
<p>The values in Timer0 are how long the signal was at zero for and the Timer1 was how long it was high for.</p>
<p>The logic analyzer should look <em>sort of like</em> the following:</p>
<p><img src="la.png" /></p>
<p><strong>WARNING:</strong> On my remote control, the full remote control signal was about 80ms. Please note that remote control data packets are not standardized, so the remote that you use to perform these experiment will almost certainly generate results different from those that your neighbor&#8217;s remote will generate.</p>
<p>Also, different remotes do different things. It appears remotes send the same command multiple times (~ x3). However, they do it differently.</p>
<p><img src="pics/3-signals-1.jpg" /></p>
<p>The above remote sends one good packet and 2 <em>empty</em> packets immediately following one button press.</p>
<p><img src="pics/3-signals-4.jpg" /></p>
<p>This remote however, appears to send 3 copies of the same button press.</p>
<h2 id="due-day-1">Due day 1:</h2>
<p>Use the logic analyzer to measure the following information for your remote. Show your instructor these:</p>
<table>
<thead>
<tr class="header">
<th>Pulse</th>
<th>Duration (ms)</th>
<th>Timer A counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Start: logic 0 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Start: logic 1 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Data 1: logic 0 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Data 1: logic 1 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Data 0: logic 0 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Data 0: logic 1 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Stop: logic 0 half pulse</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Stop: logic 1 half pulse</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="day-2">Day 2</h1>
<h2 id="prelab-day-2">Prelab Day 2</h2>
<ul>
<li>None</li>
</ul>
<h2 id="ir-data-packets">IR data packets</h2>
<p>Connect your MSP430 back to the logic analyzer as you did during day 1. Now that you know the characteristics of your remote, we want to capture the packets now.</p>
<p><img src="protocol-signal.jpg" /></p>
<p>Write the codes (in hex) for at least 5 remote control buttons. Make sure you know both the button and the hex code. You should be able to identify the start of the message and from there identify the logic 0/1 half pulse.</p>
<h1 id="day-2-turn-in">Day 2 Turn-in</h1>
<p>Show your instructor the following table</p>
<table>
<thead>
<tr class="header">
<th>Button</th>
<th>Button name</th>
<th>Hex code (not including start and stop bits)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="day-3">Day 3</h1>
<h2 id="prelab-day-3">Prelab Day 3</h2>
<ul>
<li>Fill in the missing code of <a href="start3.c" class="uri">start3.c</a> to do the following:
<ul>
<li>You need to have working code (at least something that compiles and does everything) if you want to finish on time. <strong>Don&#8217;t</strong> wait until class to start coding!</li>
<li>I will not check you did this, but you will be late if you don&#8217;t do it.</li>
</ul></li>
</ul>
<h2 id="main">Main</h2>
<ul>
<li>Every time the P2.6 pin changes direction, you need to toggle the Red LED on or off. This is good feedback that our remote works (batteries aren&#8217;t dead) and we have setup our interrupts setup correctly</li>
<li>Every time you get a complete 32b data packet, toggle the Green LED on/off</li>
<li>Attach two additional LEDs/resistors, look back at lab 2 if you need to remember on how to do this, to your Launchpad.</li>
<li>Pressing button 1 should light up LED 1</li>
<li>Pressing button 2 should turn off LED 1</li>
<li>Pressing button 3 should blink LED 2 three times (about 1 second on and 1 second off for each blink)</li>
<li>Pressing button 4 should blink LED 2 five times (same timings as button 3)</li>
<li>Pressing button 5 should turn on/off LED 1 and 2</li>
</ul>
<p>Each of the above actions are independent. Do not hit multiple buttons at the same time or hit remote buttons to interrupt button 4 blinking lights.</p>
<h2 id="port-2-vector-data-collection">Port 2 Vector Data Collection</h2>
<p>For the IR remote data, you only need to detect the data&#8217;s logic high as either a <code>0</code> (should be short time) or a <code>1</code> (should be a long time)</p>
<h3 id="falling-edge">Falling Edge</h3>
<ol type="1">
<li>Read TAR</li>
<li>Classify logic 1 half-pulse and shift bit into <code>irPacket</code></li>
<li>Shift the 0 or 1 bit into the <code>irPacket</code></li>
<li>Turn Timer A off</li>
<li>Enable rising edge interrupt</li>
</ol>
<h3 id="rising-edge">Rising Edge</h3>
<ol type="1">
<li>set TAR = 0</li>
<li>Turn Timer A on</li>
<li>Enable Timer A interrupt</li>
<li>Enable falling edge interrupt</li>
</ol>
<p>After both rising/falling edge, clear the <code>P2IFG</code></p>
<h2 id="timer-0-vector">Timer 0 Vector</h2>
<ol type="1">
<li>Turn off Timer A</li>
<li>Turn off Timer A interrupt</li>
<li>Clear <code>TAIFG</code></li>
</ol>
<h1 id="day-3-turn-in">Day 3 Turn-in</h1>
<ul>
<li>Demonstrate the buttons working</li>
<li><strong>Only push this LED code to bitbucket, not the Day 1/2 code, by the end-of-class</strong></li>
</ul>
<h1 id="rubric">Rubric</h1>
<p><strong>WARNING:</strong> This lab has been around and I have made changes to it. When I review your code, if I see code from the old way to do the lab you will receive 0 pts for your code. Please do not cheat.</p>
<ul>
<li>[5 pts] Day one milestone: Table 1 on-time</li>
<li>[5 pts] Day two milestone: Table 2 on-time</li>
<li>[20 pts] Code organization, comments, proper header, repo organization, and good programming practices
<ul>
<li>Push code by end-of-lab on Day 3 so I can review it.</li>
</ul></li>
<li>[10 pts] Launchpad Red LED blinks every time the pin changes direction</li>
<li>[10 pts] Launchpad Green LED blinks every time a 32b packet is found</li>
<li>[10 pts] Button 1 works as described</li>
<li>[10 pts] Button 2 works as described</li>
<li>[10 pts] Button 3 works as described</li>
<li>[10 pts] Button 4 works as described</li>
<li>[10 pts] Button 5 works as described</li>
</ul>

        </div>
    </body>
</html>